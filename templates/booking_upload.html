{% extends "base.html" %}
{% block title %}Importar avaliações do Booking{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="row">
    <div class="col-lg-10 mx-auto">

      <h2 class="mb-3">Importar avaliações do Booking</h2>

      <!-- Explicação do fluxo -->
      <div class="alert alert-info border-0 shadow-sm">
        <div class="d-flex align-items-start gap-3">
          <i class="bi bi-upload" style="font-size:1.6rem;"></i>
          <div>
            <div class="fw-bold mb-1">O que vai acontecer</div>
            <ul class="mb-0">
              <li>Você envia um arquivo <strong>CSV</strong> exportado do Booking.</li>
              <li>Nós salvamos <strong>todas</strong> as avaliações no mesmo modelo <strong>Review</strong> usado pelo app.</li>
              <li>A nota do Booking (0–10) é <strong>convertida</strong> para <strong>0–5</strong> (1 casa decimal), mantendo a nota original para exibição.</li>
              <li>As avaliações aparecem no <strong>Dashboard</strong>, nos <strong>Relatórios</strong> e nas <strong>Análises com IA</strong>.</li>
              <li>Elas ficam marcadas como <span class="badge bg-warning text-dark">Booking</span> para você filtrar (Google | Booking).</li>
              <li>Entradas duplicadas são evitadas automaticamente quando possível.</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Ações -->
      <div class="d-flex gap-2 flex-wrap mb-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
          <i class="bi bi-file-earmark-arrow-up me-1"></i> Enviar avaliações (CSV)
        </button>
        <button class="btn btn-outline-secondary" id="btn-checar">
          <i class="bi bi-search me-1"></i> Checar quantidade importada
        </button>
      </div>

      <!-- Resultado do upload -->
      <div id="resultado-upload" style="display:none;">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <h5 class="mb-3"><i class="bi bi-check2-circle me-2"></i>Resumo da importação</h5>
            <div class="row g-3">
              <div class="col-sm-6 col-md-3"><div class="text-muted small">Inseridas</div><div class="h5" id="ins-inserted">0</div></div>
              <div class="col-sm-6 col-md-3"><div class="text-muted small">Duplicadas</div><div class="h5" id="ins-duplicates">0</div></div>
              <div class="col-sm-6 col-md-3"><div class="text-muted small">Ignoradas</div><div class="h5" id="ins-skipped">0</div></div>
              <div class="col-sm-6 col-md-3"><div class="text-muted small">Status</div><div class="h5" id="ins-status">—</div></div>
            </div>
            <div id="ins-errors" class="mt-3" style="display:none;">
              <div class="text-muted small mb-1">Ocorreram avisos/erros:</div>
              <pre class="bg-light p-2 rounded" style="max-height:180px; overflow:auto;"></pre>
            </div>
          </div>
        </div>
      </div>

      <!-- Como obter as avaliações (colapsável) -->
      <div class="card border-0 shadow-sm">
        <div class="card-body">
          <a class="d-flex align-items-center justify-content-between text-decoration-none"
             data-bs-toggle="collapse" href="#comoObter" role="button" aria-expanded="false" aria-controls="comoObter">
            <span class="fw-bold"><i class="bi bi-question-circle me-2"></i>Como obter as avaliações do Booking (CSV)</span>
            <i class="bi bi-chevron-down"></i>
          </a>
          <div class="collapse mt-3" id="comoObter">
            <ol class="mb-3">
              <li>Acesse a <a href="https://admin.booking.com/" class="link-primary" target="_blank" rel="noopener">Extranet do Booking</a> e faça login na propriedade correta.</li>
              <li>No menu, vá em <strong>Avaliações</strong> / <strong>Guest Reviews</strong>.</li>
              <li>Procure a opção de <strong>exportar/baixar</strong> avaliações e selecione o formato <strong>CSV</strong>.</li>
              <li>Salve o arquivo no seu computador.</li>
              <li>Volte aqui e clique em <strong>“Enviar avaliações (CSV)”</strong>.</li>
            </ol>
            <p class="text-muted small mb-0">
              Dica: alguns rótulos podem variar conforme o idioma da conta. Se estiver no app móvel (Pulse),
              a exportação CSV nem sempre está disponível — use a Extranet no navegador.
            </p>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Modal (estética semelhante à captura) -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-body p-4">
        <div class="mb-3 fw-semibold">Importar avaliações do Booking (CSV)</div>

        <!-- Caixa grande como no exemplo -->
        <div class="mb-3">
          <input type="text" class="form-control form-control-lg"
                 placeholder="Insira um arquivo CSV de avaliações para habilitar a importação"
                 disabled>
        </div>

        <form id="form-upload" method="POST" action="{{ url_for('booking.upload_csv') }}" enctype="multipart/form-data">
          {% if csrf_token is defined %}
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          {% endif %}

          <div class="text-center my-3">
            <label for="csv-file" class="btn btn-light border px-4 py-2 rounded-3">
              <i class="bi bi-link-45deg me-1"></i> <span class="text-primary">Clique aqui</span> para selecionar um arquivo
            </label>
            <input id="csv-file" name="file" type="file" accept=".csv" class="d-none" required>
          </div>

          <div class="text-center text-muted small mb-3">
            Formatos aceitos: <strong>csv</strong> • Tamanho máximo <strong>1.5MB</strong>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="submit" class="btn btn-primary" id="btn-enviar">
              <span class="spinner-border spinner-border-sm me-2 d-none" id="spn-enviar"></span>
              Enviar
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
// Envio com fetch para JSON + resumo
document.getElementById('form-upload').addEventListener('submit', async function (e) {
  e.preventDefault();
  const btn = document.getElementById('btn-enviar');
  const spn = document.getElementById('spn-enviar');
  const file = document.getElementById('csv-file').files[0];
  if (!file) {
    if (window.showToast) showToast('Selecione um arquivo CSV.', 'warning');
    return;
  }

  btn.disabled = true; spn.classList.remove('d-none');

  const formData = new FormData(this);
  // tenta enviar CSRF também como header se existir no form
  let csrfVal = '';
  const csrfEl = this.querySelector('input[name="csrf_token"]');
  if (csrfEl) csrfVal = csrfEl.value;

  try {
    const resp = await fetch(this.action, {
      method: 'POST',
      headers: csrfVal ? { 'X-CSRFToken': csrfVal } : {},
      body: formData
    });
    const data = await resp.json();

    btn.disabled = false; spn.classList.add('d-none');

    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadModal'));
    if (modal) modal.hide();

    const wrap = document.getElementById('resultado-upload');
    wrap.style.display = 'block';

    document.getElementById('ins-inserted').innerText   = data.inserted ?? 0;
    document.getElementById('ins-duplicates').innerText = data.duplicates ?? 0;
    document.getElementById('ins-skipped').innerText    = data.skipped ?? 0;
    document.getElementById('ins-status').innerText     = data.success ? 'Concluída' : 'Com erros';

    const errBox = document.getElementById('ins-errors');
    if (data.errors && data.errors.length) {
      errBox.style.display = 'block';
      errBox.querySelector('pre').innerText = (data.errors || []).join('\\n');
    } else {
      errBox.style.display = 'none';
    }
    if (window.showToast) showToast(data.message || 'Importação concluída!', data.success ? 'success' : 'danger');
  } catch (err) {
    btn.disabled = false; spn.classList.add('d-none');
    if (window.showToast) showToast('Falha ao enviar o arquivo.', 'danger');
  }
});

// Checar quantidade já importada
document.getElementById('btn-checar').addEventListener('click', async function () {
  try {
    const resp = await fetch('{{ url_for("booking.count_booking_reviews") }}');
    const data = await resp.json();
    if (window.showToast) showToast(`Você tem ${data.count ?? 0} avaliações do Booking importadas.`, 'info');
  } catch (e) {
    if (window.showToast) showToast('Não foi possível checar agora.', 'warning');
  }
});
</script>
{% endblock %}
