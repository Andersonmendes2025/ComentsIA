{% extends "base.html" %}
{% block title %}Automa√ß√£o Google - ComentsIA{% endblock %}
{% block content %}

<div class="container mt-4">
  <h2 class="mb-4"><i class="bi bi-gear-wide-connected me-2"></i>Automa√ß√£o Google</h2>

  <!-- FORMUL√ÅRIO DE CONFIGURA√á√ÉO -->
  <form method="post" id="configForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf_token_field">

    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <h5 class="card-title">Status da Automa√ß√£o</h5>
        <div class="form-check form-switch">
          <input class="form-check-input" type="checkbox" name="ativar" id="ativar" value="1"
                 {% if settings.gbp_auto_enabled %}checked{% endif %}>
          <label class="form-check-label" for="ativar">Automa√ß√£o ativada</label>
        </div>
        <small class="text-muted">Quando ativada, suas avalia√ß√µes novas no Google ser√£o monitoradas automaticamente.</small>
      </div>
    </div>

    <div class="text-end mb-4">
      <button type="submit" class="btn btn-primary" id="saveConfigBtn">
        <i class="bi bi-save me-1"></i>Salvar configura√ß√µes
      </button>
    </div>
  </form>

  <!-- CARD DE SINCRONIZA√á√ÉO -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5 class="card-title mb-3">
        <i class="bi bi-arrow-repeat me-2"></i>Sincronizar Avalia√ß√µes Antigas
      </h5>

      <button id="toggleHistoricBtn" class="btn btn-outline-primary w-100">
        <i class="bi bi-calendar-range me-1"></i> Mostrar op√ß√µes de sincroniza√ß√£o
      </button>

      <div id="historicOptions" class="mt-3 collapse">
        <div class="d-flex flex-wrap gap-2 justify-content-center">

          {% for dias in [30,60,90,180] %}
            {% set p = historical[dias|string] %}
            {% set valor = "%.2f"|format(p.price_cents / 100) %}

            <div class="d-flex flex-column align-items-center border rounded p-3 shadow-sm"
                 style="min-width:140px; background:#f8faff;">

              <strong>{{ dias }} dias</strong>
              <span class="text-success fw-bold mb-2">R$ {{ valor }}</span>

              <!-- BOT√ÉO DE PAGAMENTO -->
              <button class="btn btn-outline-primary w-100 mb-2 pay-btn"
                      data-stripe-key="retro_{{ dias }}"
                      data-period="{{ dias }}">
                <i class="bi bi-credit-card"></i> Pagar
              </button>

              <!-- BOT√ÉO DE SINCRONIZAR DEPOIS DO PAGAMENTO -->
              <button class="btn btn-success w-100 sync-after-btn d-none"
                      data-period="{{ dias }}">
                <i class="bi bi-cloud-upload"></i> Sincronizar agora
              </button>

            </div>
          {% endfor %}

        </div>
      </div>
    </div>
  </div>
</div>


<!-- LOADER DAS CONFIG -->
<div id="save-loader-overlay" style="display:none;">
  <div id="save-loader-card" class="text-center">
    <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
    <div><strong>Salvando configura√ß√µes...</strong></div>
  </div>
</div>

<!-- OVERLAY DE SINCRONIZA√á√ÉO -->
<div id="loader-overlay" aria-hidden="true" style="display:none;">
  <div id="loader-card" class="text-center">
    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
      <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
      <strong>Sincronizando avalia√ß√µes...</strong>
    </div>
    <div class="small mb-2" style="opacity:.9">Isso pode levar alguns instantes. N√£o feche esta p√°gina.</div>

    <div class="progress">
      <div class="progress-bar bg-light"></div>
    </div>
  </div>
</div>


<script>
function showToast(message, type) {
  const toast = document.createElement("div");
  toast.className = "toast align-items-center text-white border-0 position-fixed top-0 end-0 m-3 show fade";
  toast.style.zIndex = 1055;
  toast.style.minWidth = "280px";

  if (type === "success") toast.classList.add("bg-success");
  else if (type === "error") toast.classList.add("bg-danger");
  else toast.classList.add("bg-warning");

  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;

  document.body.appendChild(toast);
  setTimeout(() => { toast.remove(); }, 6000);
}

document.addEventListener('DOMContentLoaded', function () {
  const csrfToken = document.getElementById("csrf_token_field").value;

  // =============================
  // üî• PAGAMENTO STRIPE
  // =============================
    async function checkoutStripe(productKey, period) {
        const response = await fetch(`/stripe/checkout/${productKey}`, {
          method: "POST",
          headers: { 
            "Content-Type": "application/json",  // üî• obrigat√≥rio
            "X-CSRFToken": csrfToken 
          }
        });

        const data = await response.json();

        console.log("DEBUG CHECKOUT STRIPE:", data);  // üî• mostra o erro real no console

    if (data.success) {
      // Salva no localStorage pra saber qual per√≠odo ativar depois do pagamento
      localStorage.setItem("retro_sync_period", period);
      window.location.href = data.checkout_url;

    } else {
      showToast("Erro ao iniciar pagamento Stripe", "error");
    }
  }

  // BOT√ïES DE PAGAMENTO
  document.querySelectorAll(".pay-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.dataset.stripeKey;
      const period = btn.dataset.period;
      checkoutStripe(key, period);
    });
  });

  // =============================
  // üî• AP√ìS PAGAMENTO ‚Äì LIBERA BOT√ÉO "SINCRONIZAR"
  // =============================
  async function checkPaid() {
    const period = localStorage.getItem("retro_sync_period");
    if (!period) return;

    const r = await fetch(`/stripe/check_paid/${period}`);
    const data = await r.json();

    if (data.paid) {
      const btn = document.querySelector(`.sync-after-btn[data-period="${period}"]`);
      if (btn) btn.classList.remove("d-none");
    }
  }

  checkPaid();

  // =============================
  // üî• SINCRONIZAR DEPOIS DO PAGAMENTO
  // =============================
  document.querySelectorAll(".sync-after-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const period = btn.dataset.period;

      document.getElementById("loader-overlay").style.display = "flex";

      const response = await fetch(`/auto/sync_historical/${period}`, {
        method: "POST",
        headers: { "X-CSRFToken": csrfToken }
      });

      const data = await response.json();
      document.getElementById("loader-overlay").style.display = "none";

      if (data.success) {
        showToast(`Sincroniza√ß√£o de ${period} dias conclu√≠da!`, "success");
      } else {
        showToast(data.message || "Erro durante sincroniza√ß√£o", "error");
      }
    });
  });

  // ANIMA√á√ÉO DO SALVAR CONFIG
  const saveBtn = document.getElementById("saveConfigBtn");
  const saveOverlay = document.getElementById("save-loader-overlay");
  document.getElementById("configForm").addEventListener("submit", function () {
    saveBtn.disabled = true;
    saveOverlay.style.display = "flex";
    saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Salvando...`;
  });

  // Mostrar/ocultar op√ß√µes
  document.getElementById("toggleHistoricBtn").addEventListener("click", () => {
    document.getElementById("historicOptions").classList.toggle("show");
  });

});
</script>


<style>
#save-loader-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(2px);
  display: none;
  z-index: 2000;
  align-items: center; justify-content: center;
}
#save-loader-card {
  background: #0b1a43;
  padding: 18px 25px;
  color: #fff;
  border-radius: 12px;
  text-align: center;
}
/* overlay sync */
#loader-overlay {
  position: fixed; inset: 0;
  background: rgba(8,12,27,0.55);
  z-index: 1080;
  display: none; align-items: center; justify-content: center;
}
#loader-card {
  background: #0b1a43; color: #fff;
  border-radius: 16px; padding: 18px 20px; min-width: 280px;
}
</style>

{% endblock %}
