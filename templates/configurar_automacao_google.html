{% extends "base.html" %}
{% block title %}Automa√ß√£o Google Business - ComentsIA{% endblock %}
{% block content %}

<div class="container mt-4 mb-5">
   <!-- ======================================= -->
  <!-- üìò TUTORIAL: COMO ATIVAR A AUTOMA√á√ÉO    -->
  <!-- ======================================= -->

  <div class="card shadow-sm border-0 automacao-card mt-4">
    <div class="card-body">

      <h5 class="card-title mb-1">
        <i class="bi bi-info-circle text-primary me-2"></i>
        Como ativar a automa√ß√£o na sua ficha do Google
      </h5>

      <p class="text-muted" style="max-width: 620px;">
        Para que a ComentsIA consiga sincronizar e responder automaticamente suas avalia√ß√µes,
        voc√™ precisa mover sua ficha para um <strong>grupo de locais</strong> no Google Business.
        O processo √© simples ‚Äî siga os passos abaixo:
      </p>

      <!-- Bot√£o de abrir tutorial -->
      <button class="btn btn-outline-primary w-100 d-flex align-items-center justify-content-center gap-2"
              data-bs-toggle="collapse" 
              data-bs-target="#tutorialGBP"
              aria-expanded="false">
        <i class="bi bi-chevron-down"></i> Mostrar passo a passo
      </button>

      <!-- Conte√∫do retr√°til -->
      <div id="tutorialGBP" class="collapse mt-3">

        <div class="tutorial-step mb-4">
          <h6 class="fw-bold mb-2">
            1Ô∏è‚É£ Abra o gerenciador oficial do Google Business
          </h6>
          <p class="text-muted">
            Acesse o painel de locais do Google pelo link abaixo:
          </p>
          <a href="https://business.google.com/locations" target="_blank" class="btn btn-sm btn-primary">
            Abrir painel do Google &nbsp; <i class="bi bi-box-arrow-up-right"></i>
          </a>

          <p class="mt-2 text-muted small">
            ‚ö†Ô∏è Certifique-se de estar logado com o <strong>mesmo Gmail que criou sua conta na ComentsIA</strong>, 
            e esse Gmail deve ser o <strong>propriet√°rio</strong> da ficha.
          </p>

          <img src="{{ url_for('static', filename='step1.png') }}" class="img-fluid rounded shadow-sm mt-3">
        </div>

        <div class="tutorial-step mb-4">
          <h6 class="fw-bold mb-2">
            2Ô∏è‚É£ Clique em <strong>Criar Grupo</strong> na parte superior
          </h6>
          <p class="text-muted">
            Voc√™ pode dar o nome que preferir (ex: ‚ÄúComentsIA‚Äù, ‚ÄúMinha Empresa‚Äù, ‚ÄúAvalia√ß√µes‚Äù).
          </p>

          <img src="{{ url_for('static', filename='step2.png') }}" class="img-fluid rounded shadow-sm mt-3">
        </div>

        <div class="tutorial-step mb-4">
          <h6 class="fw-bold mb-2">
            3Ô∏è‚É£ Mova sua ficha para o grupo criado
          </h6>
          <p class="text-muted">
            Na lista de empresas, marque a caixinha da ficha ‚Üí clique em 
            <strong>A√ß√µes</strong> ‚Üí <strong>Transferir empresa</strong> ‚Üí selecione o grupo.
          </p>

          <img src="{{ url_for('static', filename='step3.png') }}" class="img-fluid rounded shadow-sm mt-3">
        </div>

        <div class="alert alert-success mt-3">
          <i class="bi bi-check-circle-fill me-1"></i>
          Pronto! Sua ficha est√° conectada corretamente. A automa√ß√£o agora consegue monitorar e responder
          suas avalia√ß√µes diariamente.
        </div>

      </div>
    </div>
  </div>

  <!-- CABE√áALHO PRINCIPAL -->
  <div class="d-flex flex-wrap align-items-center justify-content-between mb-4">
    <div>
      <h2 class="mb-1">
        <i class="bi bi-magic me-2 text-primary"></i>
        Central de Automa√ß√£o Google Business
      </h2>
      <p class="text-muted mb-0" style="max-width: 640px;">
        Configure a intelig√™ncia da ComentsIA para monitorar e responder, de forma autom√°tica e elegante,
        √†s avalia√ß√µes recebidas no seu perfil do Google Business.
      </p>
    </div>

    <div class="mt-3 mt-md-0 text-md-end">
      <div class="badge bg-primary-subtle text-primary fw-semibold px-3 py-2 rounded-pill">
        <i class="bi bi-lightning-charge-fill me-1"></i>
        Automa√ß√£o avan√ßada de reputa√ß√£o
      </div>
    </div>
  </div>

  <!-- FORMUL√ÅRIO DE CONFIGURA√á√ÉO -->
  <form method="post" id="configForm" class="mb-4">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf_token_field">

    <div class="card shadow-sm border-0 mb-3 automacao-card">
      <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
          <div>
            <h5 class="card-title mb-1">
              <i class="bi bi-sliders me-2 text-primary"></i>
              Orquestra√ß√£o da Automa√ß√£o Di√°ria
            </h5>
            <p class="text-muted mb-0" style="max-width: 520px;">
              Ao ativar a automa√ß√£o, a ComentsIA assume o acompanhamento integral das suas avalia√ß√µes e 
              entrega respostas refinadas, com linguagem perfeitamente harmonizada ao posicionamento da sua marca.
            </p>
          </div>
        </div>

        <div class="d-flex flex-wrap align-items-center justify-content-between">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="ativar" id="ativar" value="1"
                   {% if settings.gbp_auto_enabled %}checked{% endif %}>
            <label class="form-check-label fw-semibold" for="ativar">
              Automa√ß√£o ativa para novas avalia√ß√µes
            </label>
          </div>
          <small class="text-muted">
            O monitoramento ocorre em janelas regulares ao longo do dia, sem interferir no uso do sistema.
          </small>
        </div>
      </div>
    </div>

    <div class="text-end">
      <button type="submit" class="btn btn-primary px-4" id="saveConfigBtn">
        <i class="bi bi-save me-1"></i>
        Guardar configura√ß√µes
      </button>
    </div>
  </form>

  <!-- CARD DE SINCRONIZA√á√ÉO HIST√ìRICA -->
  <div class="card shadow-sm border-0 automacao-card">
    <div class="card-body">
      <div class="d-flex flex-wrap justify-content-between align-items-start mb-3">
        <div>
          <h5 class="card-title mb-1">
            <i class="bi bi-arrow-counterclockwise me-2 text-primary"></i>
            Sincroniza√ß√£o Hist√≥rica de Avalia√ß√µes
          </h5>
          <p class="text-muted mb-0" style="max-width: 560px;">
            Reimporte avalia√ß√µes antigas do Google Business com todo o cuidado, permitindo que a ComentsIA
            responda, organize e traga intelig√™ncia tamb√©m para o seu hist√≥rico.
          </p>
        </div>

        {% if settings.plano == "free" %}
        <div class="mt-3 mt-md-0">
          <span class="badge bg-warning-subtle text-warning-emphasis px-3 py-2 rounded-pill">
            <i class="bi bi-lock-fill me-1"></i>
            Exclusivo para planos pagos
          </span>
        </div>
        {% endif %}
      </div>

      {% if settings.plano == "free" %}
      <div class="alert alert-warning border-0 shadow-sm mb-3" style="font-size: 0.92rem;">
        <strong>Funcionalidade indispon√≠vel no Plano Gratuito.</strong><br>
        A sincroniza√ß√£o hist√≥rica de avalia√ß√µes √© um recurso premium, destinado a clientes dos planos
        superiores, que desejam uma curadoria profunda do hist√≥rico de feedbacks com suporte
        inteligente da ComentsIA.
      </div>
      {% endif %}

      <button id="toggleHistoricBtn"
              class="btn btn-outline-primary w-100"
              {% if settings.plano == "free" %} disabled style="opacity:0.6; cursor:not-allowed;"{% endif %}>
        <i class="bi bi-calendar-range me-1"></i>
        Exibir op√ß√µes de sincroniza√ß√£o hist√≥rica
      </button>

      <div id="historicOptions" class="mt-3 collapse">
        <div class="d-flex flex-wrap gap-3 justify-content-center">

          {% for dias in [30, 60, 90, 180] %}
            {% set p = historical[dias|string] %}
            {% set valor = "%.2f"|format(p.price_cents / 100) %}

            <div class="historico-card d-flex flex-column align-items-stretch border rounded-3 p-3 shadow-sm position-relative">

              <div class="w-100 mb-1 d-flex justify-content-between align-items-center">
                <strong class="fs-6">{{ dias }} dias de hist√≥rico</strong>
                <span class="badge bg-primary-subtle text-primary-emphasis">
                  Curadoria retroativa
                </span>
              </div>

              <p class="text-muted mb-2 small">
                Importa√ß√£o das avalia√ß√µes publicadas nos √∫ltimos {{ dias }} dias, com respostas
                geradas e registradas diretamente na sua conta.
              </p>

              <div class="w-100 d-flex justify-content-between align-items-center mb-2">
                <span class="text-success fw-bold fs-6">R$ {{ valor }}</span>
              </div>

              <!-- BOT√ÉO DE PAGAMENTO -->
              <button class="btn btn-outline-primary w-100 mb-2 pay-btn"
                      data-stripe-key="retro_{{ dias }}"
                      data-period="{{ dias }}"
                      {% if settings.plano == "free" %}
                        disabled style="opacity:0.5; cursor:not-allowed;"
                        title="Dispon√≠vel apenas em planos pagos"
                      {% endif %}>
                <i class="bi bi-credit-card me-1"></i>
                Adquirir sincroniza√ß√£o
              </button>

              <!-- BOT√ÉO DE SINCRONIZAR DEPOIS DO PAGAMENTO -->
              <button class="btn btn-success w-100 sync-after-btn d-none"
                      data-period="{{ dias }}"
                      {% if settings.plano == "free" %}
                        disabled style="opacity:0.5; cursor:not-allowed;"
                        title="Dispon√≠vel apenas em planos pagos"
                      {% endif %}>
                <i class="bi bi-cloud-upload me-1"></i>
                Iniciar sincroniza√ß√£o agora
              </button>

            </div>
          {% endfor %}

        </div>
      </div>

      {% if settings.plano != "free" %}
      <p class="text-muted small mt-3 mb-0">
        <i class="bi bi-info-circle me-1"></i>
        Ap√≥s a confirma√ß√£o do pagamento, a op√ß√£o de sincroniza√ß√£o ser√° liberada automaticamente
        para o per√≠odo correspondente.
      </p>
      {% endif %}
    </div>
  </div>
</div>


<!-- LOADER DAS CONFIG -->
<div id="save-loader-overlay" style="display:none;">
  <div id="save-loader-card" class="text-center">
    <div class="spinner-border spinner-border-sm mb-2" role="status"></div>
    <div><strong>Guardando configura√ß√µes...</strong></div>
    <div class="small" style="opacity:.85;">Aguarde apenas um instante.</div>
  </div>
</div>

<!-- OVERLAY DE SINCRONIZA√á√ÉO -->
<div id="loader-overlay" aria-hidden="true" style="display:none;">
  <div id="loader-card" class="text-center">
    <div class="d-flex align-items-center justify-content-center gap-2 mb-2">
      <div class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></div>
      <strong>Sincronizando avalia√ß√µes hist√≥ricas...</strong>
    </div>
    <div class="small mb-2" style="opacity:.9">
      Este processo pode levar alguns instantes, conforme o volume de avalia√ß√µes. Por favor, permane√ßa nesta p√°gina.
    </div>

    <div class="progress" style="height: 5px; border-radius: 999px; background: rgba(255,255,255,0.25);">
      <div class="progress-bar bg-light" style="width: 100%; animation: loadingStripe 1.4s infinite;"></div>
    </div>
  </div>
</div>


<script>
function showToast(message, type) {
  const toast = document.createElement("div");
  toast.className = "toast align-items-center text-white border-0 position-fixed top-0 end-0 m-3 show fade";
  toast.style.zIndex = 1055;
  toast.style.minWidth = "280px";

  if (type === "success") toast.classList.add("bg-success");
  else if (type === "error") toast.classList.add("bg-danger");
  else toast.classList.add("bg-warning");

  toast.innerHTML = `
    <div class="d-flex">
      <div class="toast-body">${message}</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
    </div>`;

  document.body.appendChild(toast);
  setTimeout(() => { toast.remove(); }, 6000);
}

document.addEventListener('DOMContentLoaded', function () {
  const csrfTokenInput = document.getElementById("csrf_token_field");
  const csrfToken = csrfTokenInput ? csrfTokenInput.value : "";

  const isFree = {{ 'true' if settings.plano == 'free' else 'false' }};

  // Bloqueios extras no front para plano Free
  if (isFree) {
    document.querySelectorAll(".pay-btn").forEach(btn => {
      btn.style.pointerEvents = "none";
    });
    document.querySelectorAll(".sync-after-btn").forEach(btn => {
      btn.style.pointerEvents = "none";
    });
    const toggleBtn = document.getElementById("toggleHistoricBtn");
    if (toggleBtn) {
      toggleBtn.style.pointerEvents = "none";
    }
  }

  // =============================
  // üî• PAGAMENTO STRIPE
  // =============================
  async function checkoutStripe(productKey, period) {
    try {
      const nextUrl = window.location.href;

      const response = await fetch(`/stripe/checkout/${productKey}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
          next_url: nextUrl
        })
      });


      const data = await response.json();
      console.log("DEBUG CHECKOUT STRIPE:", data);

      if (data.success) {
        // Guarda o per√≠odo escolhido para libera√ß√£o posterior
        localStorage.setItem("retro_sync_period", period);
        window.location.href = data.checkout_url;
      } else {
        showToast(data.message || "N√£o foi poss√≠vel iniciar o pagamento Stripe.", "error");
      }
    } catch (e) {
      console.error(e);
      showToast("Ocorreu um erro ao iniciar o pagamento. Tente novamente em instantes.", "error");
    }
  }

  // BOT√ïES DE PAGAMENTO
  document.querySelectorAll(".pay-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const key = btn.dataset.stripeKey;
      const period = btn.dataset.period;
      checkoutStripe(key, period);
    });
  });

  // =============================
  // üî• AP√ìS PAGAMENTO ‚Äì LIBERA BOT√ÉO "SINCRONIZAR"
  // =============================
  async function checkPaid() {
    const period = localStorage.getItem("retro_sync_period");
    if (!period) return;

    try {
      const r = await fetch(`/stripe/check_paid/${period}`);
      const data = await r.json();

      if (data.paid) {
        const btn = document.querySelector(`.sync-after-btn[data-period="${period}"]`);
        if (btn) {
          btn.classList.remove("d-none");
          showToast(`Pagamento confirmado. A sincroniza√ß√£o de ${period} dias est√° dispon√≠vel para iniciar.`, "success");
        }
      }
    } catch (e) {
      console.error(e);
    }
  }

  checkPaid();

  // =============================
  // üî• SINCRONIZAR DEPOIS DO PAGAMENTO
  // =============================
  document.querySelectorAll(".sync-after-btn").forEach(btn => {
    btn.addEventListener("click", async () => {
      const period = btn.dataset.period;

      const overlay = document.getElementById("loader-overlay");
      if (overlay) overlay.style.display = "flex";

      try {
        const response = await fetch(`/auto/sync_historical/${period}`, {
          method: "POST",
          headers: { "X-CSRFToken": csrfToken }
        });

        const data = await response.json();

        if (overlay) overlay.style.display = "none";

        if (data.success) {
          showToast(`Sincroniza√ß√£o de ${period} dias conclu√≠da com √™xito.`, "success");

          setTimeout(() => {
            localStorage.removeItem("retro_sync_period");
            location.reload();
          }, 1200);
        } else {
          showToast(data.message || "Ocorreu um erro durante a sincroniza√ß√£o hist√≥rica.", "error");
        }
      } catch (e) {
        if (overlay) overlay.style.display = "none";
        console.error(e);
        showToast("N√£o foi poss√≠vel concluir a sincroniza√ß√£o. Tente novamente em alguns instantes.", "error");
      }
    });
  });

  // ANIMA√á√ÉO DO SALVAR CONFIG
  const saveBtn = document.getElementById("saveConfigBtn");
  const saveOverlay = document.getElementById("save-loader-overlay");
  const configForm = document.getElementById("configForm");

  if (configForm && saveBtn && saveOverlay) {
    configForm.addEventListener("submit", function () {
      saveBtn.disabled = true;
      saveOverlay.style.display = "flex";
      saveBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span> Guardando...`;
    });
  }

  // Mostrar/ocultar op√ß√µes hist√≥ricas
  const toggleHistoricBtn = document.getElementById("toggleHistoricBtn");
  const historicOptions = document.getElementById("historicOptions");

  if (toggleHistoricBtn && historicOptions) {
    toggleHistoricBtn.addEventListener("click", () => {
      historicOptions.classList.toggle("show");
    });
  }
});
</script>


<style>
.tutorial-step img {
  border: 1px solid rgba(0,0,0,0.08);
}

.automacao-card {
  border-radius: 18px;
  background: linear-gradient(145deg, #ffffff, #f4f7ff);
}

.historico-card {
  min-width: 220px;
  max-width: 260px;
  background: #f8faff;
  border-color: rgba(57, 132, 255, 0.15) !important;
  transition: transform 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
}

.historico-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.12);
  border-color: rgba(57, 132, 255, 0.35) !important;
}

/* Overlay salvar config */
#save-loader-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.45);
  backdrop-filter: blur(2px);
  display: none;
  z-index: 2000;
  align-items: center; justify-content: center;
}
#save-loader-card {
  background: #0b1a43;
  padding: 18px 25px;
  color: #fff;
  border-radius: 12px;
  text-align: center;
}

/* overlay sync */
#loader-overlay {
  position: fixed; inset: 0;
  background: rgba(8,12,27,0.55);
  z-index: 1080;
  display: none; align-items: center; justify-content: center;
}
#loader-card {
  background: #0b1a43; color: #fff;
  border-radius: 16px; padding: 18px 22px; min-width: 280px; max-width: 380px;
}

/* anima√ß√£o da barra de progresso */
@keyframes loadingStripe {
  0%   { transform: translateX(-100%); }
  50%  { transform: translateX(-10%); }
  100% { transform: translateX(0%); }
}
</style>

{% endblock %}
