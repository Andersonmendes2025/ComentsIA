{% extends "base.html" %}

{% block title %}Relatórios de Avaliações - ComentsIA{% endblock %}

{% block content %}
<div class="container mt-5">
  <h2 class="mb-3">
    <i class="bi bi-file-earmark-bar-graph me-2"></i> Relatórios de Avaliações
  </h2>
  <p class="text-muted mb-4">
    Gere relatórios completos das suas avaliações, com gráficos, análise profissional e resumo dos principais pontos positivos e negativos.
  </p>

  <!-- Informações do plano e uso mensal -->
  <div id="plano-info" class="alert alert-info text-center mb-4">
    Carregando informações do plano...
  </div>

  {% if user_plano == 'free' %}
    <div class="py-3 px-4 mb-4 shadow-sm text-center"
         style="background: linear-gradient(90deg,#fffbe7 80%,#fff5d1 100%); border-radius: 13px;">
      <div>
        <i class="bi bi-lock-fill fs-2 text-warning mb-2"></i>
        <div class="fw-semibold mb-2" style="color:#6c5700">
          O download de relatórios em PDF está disponível apenas no <b>plano PRO</b> ou superior.
        </div>
        <a href="{{ url_for('planos') }}"
           class="btn btn-sm btn-primary mt-2 shadow-sm"
           style="border-radius: 8px; min-width:140px;">
          Veja os planos
        </a>
      </div>
    </div>
  {% elif limite_relatorio_atingido %}
    <div class="py-3 px-4 mb-4 shadow-sm text-center"
         style="background: linear-gradient(90deg,#ffe7e7 80%,#ffdad1 100%); border-radius: 13px;">
      <div>
        <i class="bi bi-exclamation-triangle-fill fs-2 text-danger mb-2"></i>
        <div class="fw-semibold mb-2" style="color:#7c3535">
          Você atingiu o limite mensal de relatórios em PDF do seu plano.
        </div>
        <a href="{{ url_for('planos') }}"
           class="btn btn-sm btn-primary mt-2 shadow-sm"
           style="border-radius: 8px; min-width:140px;">
          Faça upgrade
        </a>
      </div>
    </div>
  {% endif %}

  <div class="row">
    <div class="col-lg-8">
      <div class="card shadow-sm p-4 mb-4">
        <form id="form-relatorio" method="post">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <div class="row">
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-calendar me-1"></i>Período:</label>
              <select name="periodo" class="form-control mb-2">
                <option value="90dias">Últimos 90 dias</option>
                <option value="6meses">Últimos 6 meses</option>
                <option value="1ano">Último 1 ano</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-star me-1"></i>Nota:</label>
              <select name="nota" class="form-control mb-2">
                <option value="todas">Todas</option>
                <option value="1">1 estrela</option>
                <option value="2">2 estrelas</option>
                <option value="3">3 estrelas</option>
                <option value="4">4 estrelas</option>
                <option value="5">5 estrelas</option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label"><i class="bi bi-chat-left-quote me-1"></i>Respondida:</label>
              <select name="respondida" class="form-control mb-2">
                <option value="todas">Todas</option>
                <option value="sim">Somente respondidas</option>
                <option value="nao">Somente não respondidas</option>
              </select>
            </div>
          </div>
          <div class="d-flex justify-content-end">
            <button type="submit"
                    class="btn btn-primary mt-3"
                    id="btn-gerar-pdf"
                    {% if user_plano == 'free' or limite_relatorio_atingido %}disabled style="pointer-events:none; background:#a0a4ad; border-color:#a0a4ad;" title="Disponível apenas no PRO ou superior"{% endif %}>
              <i class="bi bi-file-earmark-arrow-down me-1"></i>
              Gerar PDF
            </button>
            <a href="{{ url_for('historico_relatorios') }}" class="btn btn-primary mt-3 ms-2">
              <i class="bi bi-clock-history me-1"></i> Histórico
            </a>
          </div>
        </form>
      </div>
    </div>
    <div class="col-lg-4 d-none d-lg-block">
      <div class="card shadow-sm mb-4 p-3 text-center">
        <h6 class="mb-3"><i class="bi bi-lightbulb me-1"></i>Como funciona?</h6>
        <ul class="list-unstyled small text-start mb-3">
          <li>• Escolha o período, nota e respondidas.</li>
          <li>• Clique em <b>Gerar PDF</b> para baixar seu relatório completo.</li>
          <li>• O relatório inclui gráficos, análise e principais elogios/críticas.</li>
        </ul>
        <img src="{{ url_for('static', filename='exemplo_relatorio.png') }}" alt="Exemplo Gráfico" class="img-fluid rounded shadow" style="max-width:230px;">
      </div>
    </div>
  </div>
</div>

<script>
  // Atualiza info do plano e uso mensal de relatórios PDF
  function atualizarInfoPlano() {
    fetch('/get_relatorios_count')
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          const planoNome = "{{ PLANOS[user_plano].nome }}";
          const limite = {{ PLANOS[user_plano].relatorio_pdf_mes or 'null' }};
          let texto = `Você está no plano <strong>${planoNome}</strong>. `;
          if (limite) {
            texto += `Relatórios PDF gerados este mês: <strong>${data.usados}</strong> / <strong>${limite}</strong>.`;
          } else {
            texto += 'Relatórios PDF mensais ilimitados.';
          }
          document.getElementById('plano-info').innerHTML = texto;
        } else {
          document.getElementById('plano-info').textContent = 'Erro ao carregar informações do plano.';
        }
      });
  }

  function mostrarGerandoRelatorio() {
    showToast(
      '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Gerando relatório...',
      'info'
    );
  }
  function mostrarRelatorioConcluido() {
    showToast('Relatório concluído!', 'success');
  }

  document.addEventListener('DOMContentLoaded', function() {
    atualizarInfoPlano();

    // Só ativa AJAX se o botão não estiver desabilitado
    const btnGerar = document.getElementById('btn-gerar-pdf');
    const form = document.getElementById('form-relatorio');
    if (!btnGerar.disabled) {
      form.onsubmit = async function(e) {
        e.preventDefault();
        mostrarGerandoRelatorio();

        const formData = new FormData(form);

        try {
          const response = await fetch(form.action || window.location.pathname, {
            method: 'POST',
            body: formData,
          });

          if (response.ok) {
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = "relatorio.pdf";
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);

            mostrarRelatorioConcluido();
            atualizarInfoPlano(); // Atualiza o contador após baixar
          } else {
            showToast('Erro ao gerar relatório.', 'danger');
          }
        } catch (err) {
          showToast('Erro ao conectar ao servidor.', 'danger');
        }
      }
    }
  });
</script>
{% endblock %}
