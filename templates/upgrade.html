{% extends "base.html" %}
{% block title %}Atualizar Plano - ComentsIA{% endblock %}
{% block content %}

<div class="container mt-4">

  <h2 class="fw-bold mb-3">
    <i class="bi bi-stars text-primary"></i> Atualizar Plano
  </h2>

  <p class="text-muted">
    Seu plano atual:
    <span class="badge bg-primary">{{ plano_atual|capitalize }}</span>
  </p>

  {% if not planos_exibir %}
      <div class="alert alert-success mt-4">
        <i class="bi bi-trophy-fill"></i>
        Você já está no melhor plano (Business)!
      </div>
  {% endif %}

  <div class="row g-4 mt-3">

    {% for key in planos_exibir %}
    <div class="col-md-4">

      <div class="card shadow-sm border rounded-3 h-100">
        <div class="card-body d-flex flex-column">

          <h4 class="fw-bold text-center">{{ planos_info[key].title }}</h4>

          <ul class="mt-3">
            {% for b in planos_info[key].beneficios %}
            <li>{{ b }}</li>
            {% endfor %}
          </ul>

          <div class="mt-auto">
            <button 
              class="btn btn-primary w-100 pay-btn mt-3"
              data-stripe-key="{{ key }}">
              <i class="bi bi-box-arrow-up-right"></i> Fazer Upgrade
            </button>
          </div>

        </div>
      </div>

    </div>
    {% endfor %}
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".pay-btn").forEach(btn => {
        btn.addEventListener("click", async () => {
            const plan = btn.dataset.stripeKey;

            const r = await fetch(`/stripe/checkout/${plan}`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token() }}"
                }
            });

            const data = await r.json();

            if (data.success) {
                window.location.href = data.checkout_url;
            } else {
                showToast("Erro ao iniciar pagamento.", "error");
            }
        });
    });
});
</script>

{% endblock %}
