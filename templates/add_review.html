{% extends "base.html" %}

{% block title %}Adicionar Avaliação - Gerenciador de Avaliações Google{% endblock %}

{% block extra_head %}
<style>
.star-rating {
    font-size: 2rem;
    cursor: pointer;
    user-select: none;
}
.star-rating .star {
    transition: color 0.2s;
    color: #d0d0d0;
}
.star-rating .star.active {
    color: #ffc107;
}
.badge-limite {
    margin-left: 6px;
    font-size: 0.75rem;
    border-radius: 6px;
    padding: 4px 6px;
}
.btn-modern {
    border-radius: 12px;
    padding: 10px 18px;
    font-weight: 500;
    transition: all 0.2s;
}
.btn-modern:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">

            {% if user_plano == 'free' %}
            <div class="alert alert-warning shadow-sm">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <b>Atenção:</b> No plano gratuito, você pode adicionar até <b>20 avaliações/mês</b> 
                e não tem acesso à resposta hiper compreensiva ou considerações.
                <br>
                <a href="{{ url_for('planos') }}" class="btn btn-sm btn-primary mt-2">Conheça os planos</a>
            </div>
            {% elif user_plano == 'pro' %}
            <div class="alert alert-info shadow-sm">
                <i class="bi bi-info-circle me-2"></i>
                <b>Limite do PRO:</b> Até <b>200 avaliações/mês</b>.  
                Para uso ilimitado e API, faça upgrade para o <b>Business</b>.
            </div>
            {% endif %}

            <div class="d-flex align-items-center mb-4">
                <a href="{{ url_for('reviews') }}" class="btn btn-outline-secondary me-3 rounded-circle">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h2 class="mb-1">
                        <i class="bi bi-plus-circle me-2 text-primary"></i>
                        Adicionar Nova Avaliação
                    </h2>
                    <p class="text-muted mb-0">Cole aqui uma avaliação do Google para gerar respostas personalizadas</p>
                </div>
            </div>

            <div class="card shadow-sm border-0">
                <div class="card-body p-4">
                    <form method="POST" id="reviewForm" autocomplete="off">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" id="csrf_token">

                        <!-- Nome + nota -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="reviewer_name" name="reviewer_name" placeholder="Nome do cliente" required>
                                    <label for="reviewer_name"><i class="bi bi-person me-1"></i>Nome do Cliente</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label"><i class="bi bi-star me-1"></i>Classificação</label>
                                <div class="star-rating" id="starRating">
                                    {% for i in range(1,6) %}
                                    <span class="star" data-rating="{{ i }}">&#9733;</span>
                                    {% endfor %}
                                </div>
                                <input type="hidden" id="rating" name="rating" value="5" required>
                                <small class="text-muted">Clique nas estrelas para definir a classificação</small>
                            </div>
                        </div>

                        <!-- Texto -->
                        <div class="mb-4">
                            <div class="form-floating">
                                <textarea class="form-control" id="text" name="text" placeholder="Texto da avaliação" required style="min-height: 150px;"></textarea>
                                <label for="text"><i class="bi bi-chat-square-text me-1"></i>Texto da Avaliação</label>
                            </div>
                        </div>

                        <!-- Tom -->
                        <div class="form-group mt-4">
                            <label for="tone">Tom da resposta:</label>
                            <select class="form-select mb-2" id="tone" name="tone">
                                <option value="profissional">Profissional</option>
                                <option value="amigavel">Amigável</option>
                                <option value="empatico">Empático</option>
                            </select>
                        </div>

                        <!-- Hiper -->
                        <div id="hiper-info-row" class="mt-3">
                            <input class="form-check-input" type="checkbox" value="on"
                                id="hiper_compreensiva" name="hiper_compreensiva"
                                {% if user_plano == 'free' %}disabled{% endif %}>
                            <label class="form-check-label mb-0" for="hiper_compreensiva">
                                <strong>Usar resposta hiper compreensiva</strong>
                            </label>
                            <span class="badge bg-secondary badge-limite" id="limite-hiper">
                                <span id="hiper-restante">...</span>
                            </span>
                        </div>

                        <!-- Considerações -->
                        <div class="mt-4 d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-outline-info btn-sm rounded-pill" id="toggleConsideracoes"
                                {% if user_plano == 'free' %}disabled{% endif %}>
                                <i class="bi bi-info-circle me-1"></i>Adicionar considerações para a IA
                            </button>
                            <span class="badge bg-secondary badge-limite" id="limite-consideracoes">
                                <span id="consideracoes-restante">...</span>
                            </span>
                        </div>

                        <div id="bloco-consideracoes" class="toggle-section mt-3" style="display:none;">
                            <textarea class="form-control" name="consideracoes" id="consideracoes" rows="3"
                                placeholder="Ex: contexto, observações ou justificativas para a IA"
                                {% if user_plano == 'free' %}disabled{% endif %}></textarea>
                            <div class="form-text">Essas informações não serão salvas no sistema.</div>
                        </div>

                        <!-- Botões -->
                        <div class="d-flex justify-content-between mt-4">
                            <button type="button" class="btn btn-outline-primary btn-modern" id="gerarSugestaoBtn">
                                <i class="bi bi-robot me-1"></i>Gerar sugestão
                            </button>
                            <button type="submit" class="btn btn-primary btn-modern"
                                id="adicionarAvaliacaoBtn"
                                {% if user_plano == 'free' and avaliacoes_limitadas %}disabled title="Limite de avaliações atingido"{% endif %}>
                                <i class="bi bi-check-circle me-1"></i>Adicionar Avaliação
                            </button>
                        </div>

                        <!-- Loader / resultado -->
                        <p id="loading" class="mt-3 text-muted" style="display: none;">
                            <span class="spinner-border spinner-border-sm me-2"></span>Gerando resposta...
                        </p>
                        <p id="suggestion" class="mt-3" style="display: none;"></p>
                        <div id="actions" class="mt-2" style="display: none;">
                            <button type="button" class="btn btn-success btn-sm rounded-pill" onclick="submitReviewForm()">Responder</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const csrfToken = document.getElementById('csrf_token').value;

    // ⭐ estrelas
    const stars = document.querySelectorAll('#starRating .star');
    const ratingInput = document.getElementById('rating');
    function updateStars(rating) {
        stars.forEach((s, idx) => s.classList.toggle('active', idx < rating));
        ratingInput.value = rating;
    }
    updateStars(parseInt(ratingInput.value || "5"));
    stars.forEach((s, idx) => s.addEventListener('click', () => updateStars(idx + 1)));

    // refs
    const gerarBtn   = document.getElementById('gerarSugestaoBtn');
    const hiperCheck = document.getElementById('hiper_compreensiva');
    const toggleCons = document.getElementById('toggleConsideracoes');
    const blocoCons  = document.getElementById('bloco-consideracoes');

    function atualizarBloqueioSugestao() {
        const usandoHiper = hiperCheck && hiperCheck.checked && !hiperCheck.disabled;
        const usandoCons  = blocoCons && blocoCons.style.display === 'block' && !toggleCons.disabled;
        const bloquear = usandoHiper || usandoCons;
        gerarBtn.disabled = bloquear;
        gerarBtn.classList.toggle('btn-secondary', bloquear);
        gerarBtn.classList.toggle('btn-outline-primary', !bloquear);
        gerarBtn.style.cursor = bloquear ? 'not-allowed' : '';
    }

    if (hiperCheck) hiperCheck.addEventListener('change', atualizarBloqueioSugestao);
    if (toggleCons) toggleCons.addEventListener('click', () => {
        blocoCons.style.display = (blocoCons.style.display === 'block') ? 'none' : 'block';
        atualizarBloqueioSugestao();
    });
    atualizarBloqueioSugestao();

    function aplicarLimite(which) {
        if (which === 'hiper' && hiperCheck) { hiperCheck.checked = false; hiperCheck.disabled = true; }
        if (which === 'consideracoes' && toggleCons) { toggleCons.disabled = true; blocoCons.style.display = 'none'; }
        atualizarBloqueioSugestao();
    }

    function setBadge(idNumero, usados, total) {
        const numeroEl = document.getElementById(idNumero);
        if (!numeroEl) return;
        const badgeEl = numeroEl.parentElement;
        if (!badgeEl) return;

        const avisoId = idNumero + '-aviso';
        document.getElementById(avisoId)?.remove();

        if (total === null) {
            numeroEl.textContent = `${usados}/∞`;
            badgeEl.className = 'badge bg-secondary badge-limite';
            return;
        }
        const u = Math.max(0, Math.min(usados, total));
        numeroEl.textContent = `${u}/${total}`;
        const atingiu = u >= total;
        badgeEl.className = 'badge badge-limite ' + (atingiu ? 'bg-danger' : 'bg-secondary');

        if (atingiu) {
            const aviso = document.createElement('span');
            aviso.id = avisoId;
            aviso.className = 'text-muted fst-italic small ms-2';
            aviso.innerText = '(limite atingido)';
            badgeEl.insertAdjacentElement('afterend', aviso);
            if (idNumero.includes('hiper')) aplicarLimite('hiper');
            if (idNumero.includes('consideracoes')) aplicarLimite('consideracoes');
        }
    }

    function carregarContadores() {
        // hiper
        fetch('/get_hiper_count').then(r => r.json()).then(data => {
            const total = {{ PLANOS[user_plano]['hiper_dia']|tojson }};
            if (total === null) { setBadge('hiper-restante', 0, null); return; }
            const restantes = (typeof data.usos_restantes_hiper === 'number') ? data.usos_restantes_hiper : total;
            setBadge('hiper-restante', total - restantes, total);
        });
        // consideracoes
        fetch('/get_consideracoes_count').then(r => r.json()).then(data => {
            const total = {{ PLANOS[user_plano]['consideracoes_dia']|tojson }};
            if (total === null) { setBadge('consideracoes-restante', 0, null); return; }
            const restantes = (typeof data.usos_restantes_consideracoes === 'number') ? data.usos_restantes_consideracoes : total;
            setBadge('consideracoes-restante', total - restantes, total);
        });
    }
    carregarContadores();

    const form = document.getElementById('reviewForm');
    if (form) form.addEventListener('submit', () => setTimeout(carregarContadores, 1200));

    gerarBtn.addEventListener('click', function() {
        const texto = document.getElementById('text').value;
        if (!texto) { alert('Por favor, insira o texto da avaliação.'); return; }

        document.getElementById('loading').style.display = 'block';
        document.getElementById('suggestion').style.display = 'none';
        document.getElementById('actions').style.display = 'none';

        fetch('/suggest_reply', {
            method: 'POST',
            headers: {'Content-Type': 'application/json','X-CSRFToken': csrfToken},
            body: JSON.stringify({
                review_text: texto,
                star_rating: parseInt(ratingInput.value) || 5,
                reviewer_name: document.getElementById('reviewer_name').value,
                tone: document.getElementById('tone').value,
                consideracoes: document.getElementById('consideracoes')?.value || ''
            })
        })
        .then(r => r.json()).then(data => {
            document.getElementById('loading').style.display = 'none';
            if (data.success) {
                document.getElementById('suggestion').innerText = data.suggested_reply || '';
                document.getElementById('suggestion').style.display = 'block';
                document.getElementById('actions').style.display = 'block';
            } else {
                document.getElementById('suggestion').innerText = 'Erro: ' + (data.error || 'Falha ao gerar sugestão.');
                document.getElementById('suggestion').style.display = 'block';
            }
        })
        .catch(err => { document.getElementById('loading').style.display = 'none'; alert('Erro ao gerar sugestão.'); console.error(err); });
    });
});
function submitReviewForm(){document.getElementById('reviewForm').submit();}
</script>
{% endblock %}
