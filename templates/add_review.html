{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Função para consultar o contador hiper em tempo real
    function atualizaContadorHiper() {
        fetch('/get_hiper_count')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('limite-hiper');
            if (data.success) {
                badge.innerText = data.usos_restantes_hiper + '/2 restantes';
                badge.classList.remove('bg-danger');
                badge.classList.add('bg-secondary');
                document.getElementById('hiper_compreensiva').disabled = false;

                if (data.usos_restantes_hiper <= 0) {
                    badge.innerText = 'Limite atingido';
                    badge.classList.remove('bg-secondary');
                    badge.classList.add('bg-danger');
                    document.getElementById('hiper_compreensiva').checked = false;
                    document.getElementById('hiper_compreensiva').disabled = true;
                }
            }
        });
    }

    atualizaContadorHiper(); // Chama ao abrir

    // Se o usuário marcar/desmarcar, ajusta a interface do botão de sugestão
    document.getElementById('hiper_compreensiva').addEventListener('change', function() {
        const gerarBtn = document.getElementById('gerarSugestaoBtn');
        if (this.checked) {
            gerarBtn.disabled = true;
            gerarBtn.title = "Não é possível gerar sugestão com resposta hiper compreensiva. Use o botão 'Adicionar Avaliação'.";
        } else {
            gerarBtn.disabled = false;
            gerarBtn.title = "";
        }
    });

    // Garante o estado correto do botão ao carregar (caso o checkbox venha marcado por erro)
    if (document.getElementById('hiper_compreensiva').checked) {
        document.getElementById('gerarSugestaoBtn').disabled = true;
    }

    // Ao submeter o formulário (resposta hiper), atualiza badge depois de salvar!
    document.getElementById('reviewForm').addEventListener('submit', function() {
        setTimeout(atualizaContadorHiper, 1500); // Aguarda commit no backend
    });

    // Restante do seu JS...
    // (mantém seleção de estrelas, mostrar considerações, etc)
    // ... Cole todo o seu JS padrão aqui, abaixo desse bloco!
    
    // Botão para mostrar considerações
    document.getElementById('toggleConsideracoes').addEventListener('click', function() {
        const bloco = document.getElementById('bloco-consideracoes');
        bloco.style.display = bloco.style.display === 'none' || bloco.style.display === '' ? 'block' : 'none';
    });

    // Estrelas (mantém igual ao seu original)
    let initialRating = parseInt(document.getElementById('rating').value || 5);
    const stars = document.querySelectorAll('.star-rating .star');
    for (let i = 0; i < initialRating; i++) {
        stars[i].classList.add('active');
    }
    stars.forEach(function(star, idx) {
        star.addEventListener('click', function() {
            const rating = this.getAttribute('data-rating');
            document.getElementById('rating').value = rating;
            stars.forEach(function(s) { s.classList.remove('active'); });
            for (let i = 0; i < rating; i++) {
                stars[i].classList.add('active');
            }
        });
    });

    // Botão de gerar sugestão
    document.getElementById('gerarSugestaoBtn').addEventListener('click', function() {
        generateReply();
    });
});

// AJAX para gerar sugestão (não envia se for hiper!)
function generateReply() {
    if (document.getElementById('hiper_compreensiva').checked) {
        alert('Só é possível usar a resposta hiper compreensiva pelo botão "Adicionar Avaliação".');
        return;
    }
    const nome = document.getElementById('reviewer_name').value;
    const nota = parseInt(document.getElementById('rating').value) || 5;
    const texto = document.getElementById('text').value;
    const tom = document.getElementById('tone').value;
    const consideracoes = document.getElementById('consideracoes').value;

    if (!texto) {
        alert("Por favor, insira o texto da avaliação.");
        return;
    }

    document.getElementById('loading').style.display = 'block';
    document.getElementById('suggestion').style.display = 'none';
    document.getElementById('actions').style.display = 'none';

    fetch('/suggest_reply', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            review_text: texto,
            star_rating: nota,
            reviewer_name: nome,
            tone: tom,
            consideracoes: consideracoes
        })
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('loading').style.display = 'none';
        if (data.success) {
            document.getElementById('suggestion').innerText = data.suggested_reply || "Nenhuma sugestão foi gerada.";
            document.getElementById('suggestion').style.display = 'block';
            document.getElementById('actions').style.display = 'block';
        } else {
            document.getElementById('suggestion').innerText = "Erro: " + data.error;
            document.getElementById('suggestion').style.display = 'block';
        }
    })
    .catch(error => {
        document.getElementById('loading').style.display = 'none';
        alert('Erro ao gerar sugestão.');
        console.error(error);
    });
}

// Nova função para o botão "Responder"
function submitReviewForm() {
    document.getElementById('reviewForm').submit();
}
</script>
{% endblock %}
