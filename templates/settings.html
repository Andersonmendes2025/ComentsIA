{% extends "base.html" %}

{% block title %}Configura√ß√µes - Gerenciador de Avalia√ß√µes Google{% endblock %}

{% block extra_head %}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
  .settings-card { border-left: 4px solid #007bff; }
  .preview-card { background-color: #f8f9fa; border: 2px dashed #dee2e6; }
  .form-floating textarea { min-height: 100px; }
  .terms-conditions {
    margin-top: 20px; padding: 10px;
    background-color: #f1f1f1; border-radius: 5px;
    border: 1px solid #007bff; font-size: 1rem;
  }
  .terms-conditions a { color: #007bff; text-decoration: none; }
  .terms-conditions a:hover { text-decoration: underline; }
  .modal-backdrop.show {
    opacity: 0.4 !important;
    backdrop-filter: blur(5px);
  }
</style>
{% endblock %}

{% block content %}
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="d-flex align-items-center mb-4">
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
          <i class="bi bi-arrow-left"></i>
        </a>
        <div>
          <h2 class="mb-1">
            <i class="bi bi-gear me-2"></i>
            Configura√ß√µes
          </h2>
          <p class="text-muted mb-0">Preencha suas informa√ß√µes de conta e personalize suas respostas</p>
        </div>
      </div>

      <div class="row">
        <!-- Settings Form -->
        <div class="col-lg-8 mb-4">
          <div class="card settings-card shadow-sm">
            <div class="card-header">
              <h5 class="card-title mb-0">
                <i class="bi bi-palette me-1"></i>
                Personaliza√ß√£o de Respostas
              </h5>
            </div>
            <div class="card-body">
              <form method="POST" enctype="multipart/form-data" id="settingsForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                <!-- Empresa -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="company_name" name="company_name"
                      value="{{ settings.business_name }}" placeholder="Nome do seu neg√≥cio" required>
                    <label for="company_name"><i class="bi bi-building me-1"></i> Nome da Empresa</label>
                  </div>
                  <div class="form-text">Nome da sua empresa ou neg√≥cio (obrigat√≥rio)</div>
                </div>

                <!-- Gerente -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="manager_name" name="manager_name"
                      value="{{ settings.manager_name or '' }}" placeholder="Nome do gerente">
                    <label for="manager_name"><i class="bi bi-person-badge me-1"></i> Nome do Gerente</label>
                  </div>
                  <div class="form-text">Nome do respons√°vel pela empresa. Usado nas respostas e relat√≥rios.</div>
                </div>

                <!-- Contato -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="contact_info" name="contact_info"
                      value="{{ settings.contact_info }}" placeholder="Informa√ß√µes de Contato" required>
                    <label for="contact_info"><i class="bi bi-telephone me-1"></i> Informa√ß√µes de Contato</label>
                  </div>
                  <div class="form-text">Suas informa√ß√µes de contato para incluir nas respostas (obrigat√≥rio)</div>
                </div>

                <!-- Termos -->
                <div class="terms-conditions">
                  <label for="terms_accepted" style="font-weight: normal;">
                    <input type="checkbox" class="form-check-input" id="terms_accepted" name="terms_accepted"
                      value="on" {% if settings.terms_accepted %}checked{% endif %} required>
                    Eu li e aceito integralmente os
                    <a href="{{ url_for('terms') }}" target="_blank">Termos de Uso</a> e a
                    <a href="{{ url_for('privacy_policy') }}" target="_blank">Pol√≠tica de Privacidade</a>
                    do ComentsIA.
                  </label>
                </div>

                <!-- Logo -->
                <div class="mb-4">
                  <label class="form-label" for="logo"><i class="bi bi-image me-1"></i> Logo da Empresa (PNG ou JPG, at√© 500KB)</label>
                  <input type="file" class="form-control" id="logo" name="logo" accept="image/png, image/jpeg">
                  <div class="mt-2">
                    <strong>Logo atual:</strong><br>
                    <img id="logo-preview-img"
                      src="{% if settings.logo %}data:image/png;base64,{{ settings.logo|b64encode }}{% endif %}"
                      alt="Logo da empresa"
                      style="max-height:80px;border-radius:8px;border:1px solid #eee;box-shadow:0 1px 6px #0001;{% if not settings.logo %}display:none;{% endif %}">
                  </div>
                </div>

                <!-- Sauda√ß√£o -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="default_greeting" name="default_greeting"
                      value="{{ settings.default_greeting }}" placeholder="Sauda√ß√£o Padr√£o" required>
                    <label for="default_greeting">Sauda√ß√£o Padr√£o</label>
                  </div>
                </div>

                <!-- Encerramento -->
                <div class="mb-4">
                  <div class="form-floating">
                    <textarea class="form-control" id="default_closing" name="default_closing"
                      placeholder="Encerramento Padr√£o" required>{{ settings.default_closing }}</textarea>
                    <label for="default_closing">Encerramento Padr√£o</label>
                  </div>
                </div>

                <!-- A√ß√µes -->
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                  <button type="button" class="btn btn-outline-secondary me-md-2" onclick="resetToDefaults()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Restaurar Padr√µes
                  </button>
                  <button type="submit" class="btn btn-primary">Salvar Configura√ß√µes</button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Pr√©via -->
        <div class="col-lg-4 mb-4">
          <div class="card preview-card shadow-sm">
            <div class="card-header">
              <h6 class="card-title mb-0"><i class="bi bi-eye me-1"></i> Pr√©via da Resposta</h6>
            </div>
            <div class="card-body">
              <div id="response-preview" class="p-3 bg-white rounded border">
                <div id="preview-greeting" class="fw-bold">{{ settings.default_greeting }}</div>
                <div class="my-3 text-muted fst-italic">[Aqui aparecer√° a resposta gerada pela IA]</div>
                <div id="preview-closing" class="mt-3">{{ settings.default_closing }}</div>
                <div id="preview-contact" class="mt-2 small text-muted">{{ settings.contact_info }}</div>
              </div>
              <small class="text-muted mt-2 d-block">Esta √© uma pr√©via de como suas respostas aparecer√£o com as configura√ß√µes atuais.</small>
            </div>
          </div>

          <!-- Caixa de Contexto da IA -->
          <div class="text-center mt-4">
            <button type="button" class="btn btn-primary px-4 py-2 fw-semibold" data-bs-toggle="modal" data-bs-target="#modalContextoIA">
              üí¨ Caixa de Contexto da IA
            </button>
            <p class="text-muted small mt-2">
              Com a <strong>Caixa de Contexto</strong>, voc√™ pode dar o seu tom √† IA descreva sua hist√≥ria, miss√£o, valores e palavras que devem ser evitadas.
            </p>
          </div>
        </div>
      </div>

      <hr class="my-4">

      <!-- Apagar conta -->
      <div class="mt-4">
        <h5 class="text-danger">Apagar Conta</h5>
        <p class="text-muted">Essa a√ß√£o √© irrevers√≠vel. Todos os seus dados ser√£o exclu√≠dos permanentemente.</p>
        <button id="btn-delete-account" class="btn btn-outline-danger">Apagar conta</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Caixa de Contexto -->
<div class="modal fade" id="modalContextoIA" tabindex="-1" aria-labelledby="modalContextoIALabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg border-0 rounded-4">
      <div class="modal-header bg-primary text-white rounded-top-4">
        <h5 class="modal-title fw-bold" id="modalContextoIALabel">üí¨ Contexto da Empresa (IA Personalizada)</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        {% if is_free_plan %}
          <div class="alert alert-warning text-center mb-0">
            üîí Este recurso est√° dispon√≠vel apenas nos planos <strong>Pro</strong> e <strong>Business</strong>.
          </div>
        {% else %}
          <p class="text-muted small mb-2">
            Descreva brevemente a hist√≥ria, miss√£o, valores e estilo da sua empresa. Voc√™ tamb√©m pode indicar palavras que a IA deve evitar.
          </p>
          <form id="formContextoIA">
            <textarea class="form-control" name="contexto_personalizado" id="contexto_personalizado" maxlength="500" rows="5"
              placeholder="Ex: Fundada em 2015, nossa empresa prioriza agilidade, confian√ßa e atendimento pr√≥ximo. Evite palavras como 'barato' ou 'promo√ß√£o'.">{{ settings.contexto_personalizado or '' }}</textarea>
          </form>
          <small class="text-muted d-block mt-2">Esse texto ser√° usado para personalizar as respostas autom√°ticas da IA.</small>
        {% endif %}
      </div>
      <div class="modal-footer d-flex justify-content-between">
        <button type="button" class="btn btn-outline-secondary px-4" data-bs-dismiss="modal">Cancelar</button>
        {% if not is_free_plan %}
          <button id="btnSalvarContexto" type="button" class="btn btn-primary px-4 fw-semibold">Salvar</button>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// --- Atualiza pr√©via ---
document.addEventListener('DOMContentLoaded', function () {
  const greetingInput = document.getElementById('default_greeting');
  const closingInput = document.getElementById('default_closing');
  const contactInput = document.getElementById('contact_info');
  const previewGreeting = document.getElementById('preview-greeting');
  const previewClosing = document.getElementById('preview-closing');
  const previewContact = document.getElementById('preview-contact');

  function updatePreview() {
    previewGreeting.textContent = greetingInput.value || 'Ol√°,';
    previewClosing.textContent = closingInput.value || 'Agradecemos seu feedback!';
    previewContact.textContent = contactInput.value || 'Entre em contato conosco';
  }

  greetingInput.addEventListener('input', updatePreview);
  closingInput.addEventListener('input', updatePreview);
  contactInput.addEventListener('input', updatePreview);
});

// --- Fun√ß√µes Toasts ---
function showPersistentToast(message, type = 'info') {
  const toastId = 'toast-' + Math.floor(Math.random() * 1e6);
  const colorClass = type === 'success' ? 'bg-success'
                   : type === 'danger' ? 'bg-danger'
                   : type === 'warning' ? 'bg-warning' : 'bg-info';
  const toast = document.createElement('div');
  toast.className = `toast align-items-center text-white ${colorClass} border-0 show`;
  toast.id = toastId;
  toast.setAttribute('role','alert');
  toast.setAttribute('aria-live','assertive');
  toast.setAttribute('aria-atomic','true');
  toast.style.position='fixed';
  toast.style.top='24px';
  toast.style.right='24px';
  toast.style.zIndex=9999;
  toast.innerHTML = `<div class="d-flex align-items-center"><div class="toast-body">${message}</div></div>`;
  document.body.appendChild(toast);
  return toastId;
}
function removePersistentToast(id){ const t=document.getElementById(id); if(t) t.remove(); }

// --- Salvar Configura√ß√µes ---
document.getElementById('settingsForm').onsubmit = async function (e) {
  e.preventDefault();
  const toastId = showPersistentToast(
    '<span class="spinner-border spinner-border-sm me-2" role="status"></span> Salvando configura√ß√µes...',
    'info'
  );
  const formData = new FormData(this);
  try {
    const response = await fetch(this.action || window.location.pathname, { method: 'POST', body: formData });
    removePersistentToast(toastId);
    if (response.redirected) window.location.href = response.url;
    else showToast('Erro ao salvar configura√ß√µes.', 'danger');
  } catch (err) {
    removePersistentToast(toastId);
    showToast('Erro ao conectar ao servidor.', 'danger');
  }
};

// --- Salvar Caixa de Contexto ---
// --- Helper pra pegar token do meta ---
function getCSRF() {
  const m = document.querySelector('meta[name="csrf-token"]');
  return m ? m.getAttribute('content') : '';
}

// --- Salvar Caixa de Contexto com CSRF ---
document.getElementById('btnSalvarContexto')?.addEventListener('click', async function () {
  const contexto = document.getElementById('contexto_personalizado').value.trim();
  if (!contexto) return showToast('O campo de contexto n√£o pode estar vazio.', 'warning');

  const toastId = showPersistentToast('<span class="spinner-border spinner-border-sm me-2"></span> Salvando contexto...', 'info');
  
  try {
    const response = await fetch('/settings/contexto', {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'X-CSRFToken': getCSRF()
      },
      body: new URLSearchParams({ contexto_personalizado: contexto })
    });

    const data = await response.json();
    removePersistentToast(toastId);
    if (data.success) {
      showToast('Contexto salvo com sucesso!', 'success');
      bootstrap.Modal.getInstance(document.getElementById('modalContextoIA')).hide();
    } else {
      showToast(data.error || 'Erro ao salvar contexto.', 'danger');
    }
  } catch (err) {
    removePersistentToast(toastId);
    showToast('Erro de comunica√ß√£o: ' + err.message, 'danger');
  }
});


// --- Excluir Conta ---
document.getElementById('btn-delete-account').addEventListener('click', async function () {
  if (!confirm('Tem certeza que deseja excluir sua conta? Esta a√ß√£o √© irrevers√≠vel.')) return;

  const toastId = showPersistentToast('<span class="spinner-border spinner-border-sm me-2"></span> Excluindo conta...', 'danger');

  try {
    const response = await fetch('{{ url_for("delete_account") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({})
    });
    const data = await response.json();
    removePersistentToast(toastId);
    if (data.success) {
      showToast('Conta exclu√≠da com sucesso!', 'success');
      setTimeout(() => window.location.href = '{{ url_for("index") }}', 1500);
    } else {
      showToast(data.error || 'N√£o foi poss√≠vel excluir a conta.', 'danger');
    }
  } catch (err) {
    removePersistentToast(toastId);
    showToast('Erro de comunica√ß√£o: ' + err.message, 'danger');
  }
});
</script>
{% endblock %}
