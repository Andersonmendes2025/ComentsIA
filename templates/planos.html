{% extends "base.html" %}
{% block title %}Planos - ComentsIA{% endblock %}

{% block extra_head %}
<style>
  /* === VARIÁVEIS DE TEMA (VERSÃO CLARA DO INDEX) === */
  :root {
    --landing-bg: #f5f7fb;
    --landing-ink: #0f172a;
    --landing-muted: #6b7280;
    --landing-accent: #2563eb;
    --landing-accent-soft: #e0ecff;
    --landing-border: #e5e7eb;
    --landing-card: #ffffff;
    --landing-radius-lg: 20px;
    --landing-radius-md: 14px;
    --landing-shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.12);
    --landing-shadow-card: 0 10px 30px rgba(15, 23, 42, 0.08);
  }

  /* === FUNDO CLARO IGUAL AO INDEX === */
  body {
    background:
      radial-gradient(900px 600px at 0% 0%, rgba(37,99,235,0.18), transparent 60%),
      radial-gradient(900px 600px at 100% 0%, rgba(79,70,229,0.16), transparent 60%),
      linear-gradient(180deg, #f9fafb 0%, #eef2ff 45%, #f5f7fb 100%);
    color: var(--landing-ink) !important;
  }

  /* === CARDS DE PLANOS (IGUAL OS CARDS GLASS DO INDEX) === */
  .glass {
    background: var(--landing-card);
    border: 1px solid rgba(226,232,240,0.9);
    border-radius: var(--landing-radius-md);
    padding: 22px;
    box-shadow: var(--landing-shadow-card);
    transition: transform .25s ease, box-shadow .25s ease;
  }

  .glass:hover {
    transform: translateY(-6px);
    box-shadow: 0 20px 40px rgba(0,0,0,.08);
  }

  /* === CABEÇALHO DOS PLANOS === */
  .plans-title {
    background: linear-gradient(90deg, #2563eb, #1d4ed8, #7c3aed);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    font-weight: 800;
  }

  .badge-tier {
    background: var(--landing-accent-soft);
    color: var(--landing-accent);
    border-radius: 999px;
    padding: 4px 10px;
    font-size: .8rem;
    font-weight: 600;
  }

  .badge-top {
    background: linear-gradient(135deg, #ff4fb5, #8a5bff);
    color: #fff;
    border-radius: 999px;
    padding: 4px 12px;
    font-weight: 700;
    font-size: .75rem;
  }

  /* === TEXTOS & PREÇOS === */
  .plan-name {
    font-size: 1.4rem;
    font-weight: 800;
    color: var(--landing-ink);
  }

  .price {
    font-size: 1.8rem;
    font-weight: 900;
    color: var(--landing-ink);
  }

  .price small {
    font-size: .9rem;
    color: var(--landing-muted);
  }

  .features li {
    color: var(--landing-muted);
    margin: 8px 0;
    display: flex;
    gap: .5rem;
  }
  .features i {
    color: #2563eb;
  }

  /* === BOTÕES === */
  .btn-neon {
    background: linear-gradient(135deg, #2563eb, #1d4ed8);
    color: #fff !important;
    border: none;
    border-radius: 12px;
    padding: .9rem 1rem;
    font-weight: 700;
    box-shadow: 0 10px 30px rgba(37,99,235,.25);
  }

  .btn-ghost {
    border: 1px solid var(--landing-border);
    color: var(--landing-ink);
    background: #ffffff;
    border-radius: 12px;
    padding: .9rem 1rem;
    font-weight: 600;
  }

  .btn-selected {
    background: #e2e8f0;
    cursor: default;
  }

  /* Container geral */
  .plans-container {
    max-width: 1100px;
  }
</style>
{% endblock %}

{% block content %}

<div class="container my-4 plans-page">
  <script>document.body.classList.add('plans-dark');</script>

  {% set current_tier = user_plano if user_plano else 'guest' %}

  <section class="plans-band mb-4">
    <div class="text-center mb-3">
      <h2 class="plans-title fw-extrabold m-0">Planos ComentsIA</h2>
      <p class="text-neon mt-2 mb-0">Comece grátis, evolua para o Pro ou Business quando fizer sentido.</p>
    </div>

    <div class="row g-3 plans-grid">

      <!-- FREE -->
    <div class="col-12 col-md-4">
      <div class="glass {% if user_plano == 'free' %}plan-selected{% endif %}">
        <div class="plan-head">
          <span class="badge-tier">Começo</span>
          {% if user_plano == 'free' %}
            <span class="badge-top">Plano Atual</span>
          {% endif %}
        </div>

        <div class="plan-name">Free</div>

        <div class="price">
          R$ 0 <small>/mês</small>
        </div>

        <ul class="features">
          <li><i class="bi bi-check2-circle"></i> Até <strong>{{ planos['free'].avaliacoes_mes }}</strong> avaliações/mês.</li>
          <li><i class="bi bi-x-circle text-danger"></i> Sem resposta hiper compreensiva.</li>
          <li><i class="bi bi-x-circle text-danger"></i> Sem caixa de contexto.</li>
          <li><i class="bi bi-x-circle text-danger"></i> Sem automação Google.</li>
          <li><i class="bi bi-x-circle text-danger"></i> Sem PDF.</li>
          <li><i class="bi bi-check2-circle"></i> Suporte {{ planos['free'].suporte }}.</li>
        </ul>

        <div class="mt-3">
          {% if user_plano == 'free' %}
            <button class="btn btn-ghost btn-selected w-100" disabled>
              Você já está no Free
            </button>

          {% elif current_tier in ['pro','business','business_anual','pro_anual'] %}
            <button class="btn btn-ghost w-100" disabled>
              Indisponível (downgrade)
            </button>

          {% elif current_tier == 'guest' %}
            <button class="btn btn-ghost w-100" onclick="window.location.href='{{ url_for('authorize') }}'">
              Faça login para assinar o Free
            </button>

          {% else %}
            <form method="post" action="{{ url_for('planos') }}">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="plano" value="free">
              <button type="submit" class="btn btn-ghost w-100">Voltar para Free</button>
            </form>
          {% endif %}
        </div>

      </div>
    </div>


      <!-- PRO -->
      <div class="col-12 col-md-4">
        <div class="glass {% if user_plano in ['pro','pro_anual'] %}plan-selected{% endif %}">
          <div class="plan-head">
            <span class="badge-tier">Profissional</span>
            <span class="badge-top">Mais escolhido</span>
          </div>

          <div class="plan-name">Pro</div>

          <div class="price">
            R$ {{ '%.2f'|format(planos['pro'].preco)|replace('.', ',') }}
            <small>/mês</small>
            <div><small>ou R$ {{ '%.2f'|format(planos['pro_anual'].preco)|replace('.', ',') }} /ano</small></div>
          </div>

          <div class="price-note">Para empresas que querem profissionalizar respostas.</div>

          <ul class="features">
            <li><i class="bi bi-check2-circle"></i> {{ planos['pro'].avaliacoes_mes }} avaliações/mês.</li>
            <li><i class="bi bi-check2-circle"></i> {{ planos['pro'].hiper_dia }} hiper/dia.</li>
            <li><i class="bi bi-check2-circle"></i> Caixa de contexto incluída.</li>
            <li><i class="bi bi-check2-circle"></i> Considerações por avaliação.</li>
            <li><i class="bi bi-check2-circle"></i> {{ planos['pro'].relatorio_pdf_mes }} PDF/mês.</li>
            <li><i class="bi bi-check2-circle"></i> Dashboard completo.</li>
            <li><i class="bi bi-check2-circle"></i> Automação Google disponível.</li>
            <li><i class="bi bi-x-circle text-danger"></i> Não inclui filiais.</li>
          </ul>

          <div class="mt-3 d-grid gap-2">

            {% set is_guest = current_tier in ['guest', None] %}
            {% set can_checkout_pro = current_tier in ['guest','free'] %}
            {% set can_upgrade_to_pro = current_tier in ['pro_anual'] %}
            {% set is_downgrade_from_business = current_tier in ['business','business_anual'] %}

            <!-- PRO Mensal -->
            <button type="button"
              class="btn btn-neon {% if user_plano=='pro' %}btn-selected{% endif %}"
              data-plan="pro_mensal"
              data-stripe-action="
                {% if is_guest %}login
                {% elif can_checkout_pro %}checkout
                {% elif can_upgrade_to_pro %}upgrade
                {% else %}none
                {% endif %}
              "
              {% if is_downgrade_from_business or user_plano=='pro' %}disabled{% endif %}>
              {% if is_guest %}Faça login para assinar
              {% elif user_plano=='pro' %}Pro Mensal (Atual)
              {% elif is_downgrade_from_business %}Indisponível (downgrade)
              {% else %}Assinar Pro Mensal
              {% endif %}
            </button>

            <!-- PRO Anual -->
            <button type="button"
              class="btn btn-neon {% if user_plano=='pro_anual' %}btn-selected{% endif %}"
              data-plan="pro_anual"
              data-stripe-action="
                {% if is_guest %}login
                {% elif can_checkout_pro %}checkout
                {% elif can_upgrade_to_pro %}upgrade
                {% else %}none
                {% endif %}
              "
              {% if is_downgrade_from_business or user_plano=='pro_anual' %}disabled{% endif %}>
              {% if is_guest %}Faça login para assinar
              {% elif user_plano=='pro_anual' %}Pro Anual (Atual)
              {% elif is_downgrade_from_business %}Indisponível (downgrade)
              {% else %}Assinar Pro Anual
              {% endif %}
            </button>

            <div class="price-note">
              <span class="pill-label"><i class="bi bi-clock-history"></i> Pro Anual inclui sincronização gratuita de 3 meses.</span>
            </div>

          </div>
        </div>
      </div>

      <!-- BUSINESS -->
      <div class="col-12 col-md-4">
        <div class="glass {% if user_plano in ['business','business_anual'] %}plan-selected{% endif %}">
          <div class="plan-head">
            <span class="badge-tier">Escala & Rede</span>
            {% if user_plano in ['business','business_anual'] %}
              <span class="badge-top">Plano Atual</span>
            {% endif %}
          </div>

          <div class="plan-name">Business Pro</div>

          <div class="price">
            R$ {{ '%.2f'|format(planos['business'].preco)|replace('.', ',') }}
            <small>/mês</small>
            <div><small>ou R$ {{ '%.2f'|format(planos['business_anual'].preco)|replace('.', ',') }} /ano</small></div>
          </div>

          <div class="price-note">Para redes, hotéis, clínicas e multiunidades.</div>

          <ul class="features">
            <li><i class="bi bi-check2-circle"></i> Avaliações ilimitadas.</li>
            <li><i class="bi bi-check2-circle"></i> Hiper ilimitadas.</li>
            <li><i class="bi bi-check2-circle"></i> Contexto ilimitado.</li>
            <li><i class="bi bi-check2-circle"></i> PDFs ilimitados.</li>
            <li><i class="bi bi-check2-circle"></i> Dashboard avançado.</li>
            <li><i class="bi bi-check2-circle"></i> Automação Google incluída.</li>
            <li><i class="bi bi-diagram-3"></i> Matriz + Filiais ilimitadas.</li>
            <li><i class="bi bi-headset"></i> Suporte VIP.</li>
          </ul>

          <div class="mt-3 d-grid gap-2">

            {% set is_guest = current_tier in ['guest', None] %}
            {% set can_checkout_business = current_tier in ['guest','free','pro','pro_anual'] %}
            {% set can_upgrade_to_business = current_tier in ['business'] %}
            {% set is_downgrade_business = current_tier in ['business_anual'] %}

            <!-- BUSINESS Mensal -->
            <button type="button"
              class="btn btn-ghost {% if user_plano=='business' %}btn-selected{% endif %}"
              data-plan="business_mensal"
              data-stripe-action="
                {% if is_guest %}login
                {% elif can_checkout_business %}checkout
                {% elif can_upgrade_to_business %}upgrade
                {% else %}none
                {% endif %}
              "
              {% if user_plano=='business' %}disabled{% endif %}>
              {% if is_guest %}Faça login para assinar
              {% elif user_plano=='business' %}Business Mensal (Atual)
              {% else %}Assinar Business Mensal
              {% endif %}
            </button>

            <!-- BUSINESS Anual -->
            <button type="button"
              class="btn btn-ghost {% if user_plano=='business_anual' %}btn-selected{% endif %}"
              data-plan="business_anual"
              data-stripe-action="
                {% if is_guest %}login
                {% elif can_checkout_business %}checkout
                {% elif can_upgrade_to_business %}upgrade
                {% else %}none
                {% endif %}
              "
              {% if user_plano=='business_anual' %}disabled{% endif %}>
              {% if is_guest %}Faça login para assinar
              {% elif user_plano=='business_anual' %}Business Anual (Atual)
              {% else %}Assinar Business Anual
              {% endif %}
            </button>

            <div class="price-note">
              <span class="pill-label"><i class="bi bi-clock-history"></i> Business Anual inclui sincronização gratuita de 3 meses.</span>
            </div>

          </div>
        </div>
      </div>

    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const csrfToken = "{{ csrf_token() }}";
  const isAuthenticated = {{ 'true' if user_plano is not none else 'false' }};
  const currentTier = "{{ current_tier }}";
  const loginUrl = "{{ url_for('authorize') }}";

  function showToast(message, type = 'error') {
    if (window.showToast) window.showToast(message, type);
    else alert(message);
  }

  document.querySelectorAll('[data-stripe-action]').forEach(function (btn) {
    btn.addEventListener('click', async function () {
      if (btn.disabled) return;

      const action = btn.getAttribute('data-stripe-action');
      const product = btn.getAttribute('data-plan');

      if (action === "login") {
        const next = encodeURIComponent(window.location.pathname);
        return window.location.href = `${loginUrl}?next=${next}`;
      }

      if (action === "none") {
        showToast("Este plano não está disponível para seu plano atual.", "error");
        return;
      }

      if (!isAuthenticated) {
        const next = encodeURIComponent(window.location.pathname);
        return window.location.href = `${loginUrl}?next=${next}`;
      }

      btn.disabled = true;
      const original = btn.innerHTML;
      btn.innerHTML = 'Processando...';

      const url = action === "upgrade"
        ? `/stripe/upgrade/${product}`
        : `/stripe/checkout/${product}`;

      try {
        const nextUrl = window.location.href;


        const resp = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
          },
          body: JSON.stringify({
            next_url: nextUrl
          })
        });


        const data = await resp.json();
        if (!resp.ok || !data.success) {
          showToast(data.message || "Erro ao processar.", "error");
          btn.disabled = false;
          btn.innerHTML = original;
          return;
        }

        if (data.checkout_url) {
          window.location.href = data.checkout_url;
        } else {
          showToast("Plano atualizado com sucesso!", "success");
          window.location.reload();
        }

      } catch (err) {
        showToast("Erro ao comunicar com o servidor.", "error");
        btn.disabled = false;
        btn.innerHTML = original;
      }
    });
  });
});
</script>

{% endblock %}
